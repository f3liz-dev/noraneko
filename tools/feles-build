#!/usr/bin/env ruby

require 'optparse'
require_relative './lib/initializer'
require_relative './lib/patcher'
require_relative './lib/symlinker'
require_relative './lib/builder'
require_relative './lib/dev_server'
require_relative './lib/injector'
require_relative './lib/browser_launcher'
require_relative './lib/utils'
require_relative './lib/dev_env_manager'

# Placeholder for modules that will be moved to tools/lib
module FelesBuild
end

# Main application class
class FelesBuildCLI
  def initialize(argv)
    @argv = argv
    @logger = FelesBuild::Utils::Logger.new('feles-build')
  end

  def run
    command = @argv.shift
    case command
    when 'dev'
      parse_dev_options
    when 'build'
      parse_build_options
    when 'init'
      parse_init_options
    when '--help', '-h', nil
      print_main_help
    else
      @logger.error "Unknown command: #{command}"
      print_main_help
    end
  end

  def print_main_help
    puts "Usage: feles-build <command> [options]"
    puts
    puts "Commands:"
    puts "  dev        Run the development workflow"
    puts "  build      Run the production build workflow"
    puts "  init       Initialize the development environment"
    puts
    puts "Run 'feles-build <command> --help' for more information on a specific command."
  end

  def parse_dev_options
    options = {}
    opt_parser = OptionParser.new do |opts|
      opts.banner = "Usage: feles-build dev [options]"
      opts.on("-h", "--help", "Prints this help") do
        puts opts
        exit
      end
    end
    opt_parser.parse!(@argv)
    puts "Running dev command with options: #{options}"
    FelesBuild::Initializer.run
    FelesBuild::Patcher.run
    FelesBuild::Symlinker.run
    FelesBuild::Builder.run(mode: 'dev')
    FelesBuild::DevServer.run
    FelesBuild::Injector.run('dev')
    FelesBuild::Injector.inject_xhtml(true)
    FelesBuild::DevEnvManager.setup
    FelesBuild::BrowserLauncher.run
  end

  def parse_build_options
    options = { phase: nil }
    opt_parser = OptionParser.new do |opts|
      opts.banner = "Usage: feles-build build [options]"
      opts.on("--phase PHASE", String, "Specify the build phase (before-mach or after-mach)") do |phase|
        options[:phase] = phase
      end
      opts.on("-h", "--help", "Prints this help") do
        puts opts
        exit
      end
    end
    opt_parser.parse!(@argv)

    if options[:phase].nil?
      puts "Error: --phase is required for the build command."
      puts opt_parser
      exit 1
    end

    puts "Running build command with options: #{options}"
    if options[:phase] == 'before-mach'
      FelesBuild::Symlinker.run
      FelesBuild::Builder.run(mode: 'production')
    elsif options[:phase] == 'after-mach'
      FelesBuild::Injector.run('production')
      FelesBuild::Injector.inject_xhtml(false)
    end
  end

  def parse_init_options
    options = {}
    opt_parser = OptionParser.new do |opts|
      opts.banner = "Usage: feles-build init [options]"
      opts.on("-h", "--help", "Prints this help") do
        puts opts
        exit
      end
    end
    opt_parser.parse!(@argv)
    FelesBuild::Initializer.run
    FelesBuild::Patcher.run
  end
end

if $PROGRAM_NAME == __FILE__
  cli = FelesBuildCLI.new(ARGV)
  cli.run
end
